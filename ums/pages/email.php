<?php	require_once('config.php');	require_once('classes/url.php');	require_once('classes/user.php');	require_once('classes/usergroup.php');	require_once('classes/usergroupassociation.php');	require_once('classes/synchronizable.php');		$url = new Url();		if (isset($_POST['submit']))	{		echo '<fieldset><legend>Ergebnis</legend>';		$s = $_POST['settings'] . ',';		if (empty($_POST['settings']))		{			$users = Synchronizable::load('User', User::$table);		}		else		{			$ids = array();			$command = '';			for ($i = 0; $i < strlen($s); $i++)			{				$c = $s[$i];							if ($c == ',')				{					$negated = false;					$action = null;					$id = -1;					for ($j = 0; $j < strlen($command); $j++)					{						$d = $command[$j];											if ($d == '!')							$negated = true;						elseif ($d == 'a')						{							if ($negated)							{								echo '<p>Fehler: "a" kann nicht negiert werden.</p>';								break 2; // very praktisch							}							else								$action = $d;						}						elseif ($d == 'u' || $d == 'g')							$action = $d;						elseif (is_numeric($d))						{							$num = $d;							for ($k = $j + 1; $k < strlen($command); $k++)							{								$e = $command[$k];								if (is_numeric($e))									$num .= $e;								else									break;							}							$id = $num;														break;						}					}										//if (!is_null($action))					//	echo '<p>' . ($negated ? 'Negiert' : 'Positiv') . " $action for $id</p>";										if ($action == 'a')					{						foreach (Synchronizable::load('User', User::$table) as $user)						{							if (!in_array($user->getID(), $ids))								$ids[] = $user->getID();						}					}					elseif ($action == 'u')					{						if ($negated)						{							if (($index = array_search($id, $ids)) !== false)								unset($ids[$index]);						}						else						{							if (!in_array($id, $ids))								$ids[] = $id;						}					}					elseif ($action == 'g')					{						$assocs = Synchronizable::load('UserGroupAssociation', UserGroupAssociation::$table, array('group' => $id));						$uIds = array();						foreach ($assocs as $assoc)							$uIds[] = $assoc->getUserID();						if ($negated)						{							foreach ($uIds as $uId)							{								if (($index = array_search($uId, $ids)) !== false)									unset($ids[$index]);							}						}						else						{							foreach ($uIds as $uId)							{								if (!in_array($uId, $ids))									$ids[] = $uId;							}						}					}										$command = '';				}				else					$command .= $c;			}						//print_r($ids);			$users = User::byIDs($ids);		}				$emailString = '';		foreach ($users as $user)		{			if (!empty($emailString))				$emailString .= ', ';			$emailString .= $user->getEmail();		}				$subject = isset($_POST['subject']) ? $_POST['subject'] : '';		$content = isset($_POST['content']) ? $_POST['content'] : '';				if (empty($subject) || empty($content))			echo '<p>Bitte füllen Sie alle Felder aus.</p>';		else		{			if (mail($emailString, $subject, $content, 'From:' . $config['webmasterEmail']))			{				echo '<p>Die E-Mail wurde an folgende Adressen gesendet:</p>';				echo "<p>$emailString</p>";			}			else				echo '<p>Beim Senden der E-Mails ist ein Problem aufgetreten.</p>';		}				echo '</fieldset>';	}?><p>Auf dieser Seite können Sie eine E-Mail an bestimmte oder alle Nutzer der Webseite versenden.<p><form method="post" action="<?php echo $url->toString(); ?>">	<fieldset>		<legend>Einstellungen</legend>		<ul class="inputList">			<li><input type="text" name="settings" /></li>		</ul>		<p>Lassen Sie das obere Textfeld leer, wenn die E-Mail an alle Nutzer gesendet werden soll.</p>		<p>Ansonsten können Sie Benutzer und Gruppen festlegen, an die die E-Mail gesendet werden sollen.		Separieren Sie die Einstellungen bitte mit einem Komma. "a" selektiert alle Nutzer. Der Präfix für Gruppen lautet "g", der Präfix für Benutzer lautet "u". Dem Präfix folgt die ID.		Wenn Sie einen bestimmten Nutzer oder eine bestimmte Gruppe ausschließen möchten, schreiben Sie ein ! vor den Präfix. Ihr Eintrag wird von links nach rechts ausgewertet. Beispiel:</p>		<p><i>g2,!u6,u3</i></p>		<p>Hier werden alle Nutzer von der Gruppe mit der ID 2 ausgewählt, außer dem Nutzer mit der ID 6. Außerdem wird der Nutzer mit der ID 3 ausgewählt.</p>		<p><i>a,!g2</i></p>		<p>Diese Einstellung sendet eine E-Mail an alle Nutzer außer denen, die in der Gruppe mit der ID 2 sind.</p>	</fieldset>	<fieldset>		<legend>E-Mail</legend>		<table id="emailTable">			<tbody>				<tr>					<td><label for="subject">Betreff</label></td>					<td><input type="text" name="subject" /></td>				</tr>				<tr>					<td><label for="content">Inhalt</label></td>					<td><textarea name="content"></textarea></td>				</tr>				<tr>					<td colspan="2"><input type="submit" name="submit" value="Absenden" /></td>				</tr>			</tbody>		</ul>	</fieldset></form>